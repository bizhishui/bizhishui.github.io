---
title: Kokkos
layout: post
guid: urn:uuid:42c919cc-9736-42ef-b086-73135f4fae10
categories:
  - notes
tags:
  - Portability
  - Cmake
---

&nbsp;

### Building and Installing Kokkos with Cmake

```
    # on my office computer
    cmake .. -DCMAKE_CXX_COMPILER=/usr/bin/g++ -DCMAKE_INSTALL_PREFIX=/data/code/myLibs/kokkos -DKokkos_ENABLE_OPENMP=On -DKokkos_ARCH_HSW=On -DKokkos_ENABLE_HWLOC=On
    # on mesocenter
    # source ../scripts/loadModules.sh 
    module purge
    module load userspace/all
    module load cmake/3.20.2
    # use GNU compiler
    module load gcc/7.2.0
    module load openmpi/gcc72
    export CXX=`which g++`
    cmake .. -DCMAKE_CXX_COMPILER=$CXX -DCMAKE_INSTALL_PREFIX=/home/jlv/libs/kokkos/GNU -DKokkos_ENABLE_OPENMP=On -DKokkos_ARCH_HSW=On -DKokkos_ENABLE_HWLOC=On
    # use GNU compiler
    module load intel-compiler/64/2020.2.254
    export CXX=`which icpc`
    cmake .. -DCMAKE_CXX_COMPILER=$CXX -DCMAKE_INSTALL_PREFIX=/home/jlv/libs/kokkos/INTEL -DKokkos_ENABLE_OPENMP=On -DKokkos_ARCH_HSW=On -DKokkos_ENABLE_HWLOC=On

    make -j 4 & make install
```

&nbsp;

#### Small project (single source file) using Kokkos
Suppose we have an application called *myApp.cpp*, which uses Kokkos. The *CMakeLists.txt* codes such as following
```
    cmake_minimum_required (VERSION 3.12)
    project (myApp CXX)
    find_package(Kokkos REQUIRED)
    
    add_executable(myApp myApp.cpp)
    target_link_libraries(myApp PRIVATE Kokkos::kokkos)

    add_library(target ${SRCS})
    # Kokkos is needed to build the lib AND any apps use this lib
    target_link_libraries(target PUBLIC Kokkos::kokkos)
    # Kokkos is needed to build the lib BUT apps use this lab doesn't need Kokkos
    target_link_libraries(target PRIVATE Kokkos::kokkos)
```

And the application is simply built as
```
    cmake . -DKokkos_DIR=/data/code/myLibs/kokkos/lib/cmake/Kokkos
    make 
    export OMP_NUM_THREADS=8
    export OMP_PROC_BIND=spread OMP_PLACES=threads
    ./myApp
```


&nbsp;

### Inline Builds
For individual projects, it may be preferable to build Kokkos inline rather than link to an installed package. The main reason is that you may otherwise need many different configurations 
of Kokkos installed depending on the required compile time features an application needs. For example there is only one default execution space, which means you need different installations 
to have OpenMP or Pthreads as the default space. Also for the CUDA backend there are certain choices, such as allowing relocatable device code, which must be made at installation time. 
Building Kokkos inline uses largely the same process as compiling an application against an installed Kokkos library.

For CMake, this means copying over the Kokkos source code into your project and adding *add_subdirectory(kokkos)* to your *CMakeLists.txt*.
